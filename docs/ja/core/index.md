# Gemini CLIコア

Gemini CLIのコアパッケージ（`packages/core`）は、Gemini CLIのバックエンド部分であり、Gemini APIとの通信、ツールの管理、`packages/cli`から送信されたリクエストの処理を担当します。Gemini CLIの一般的な概要については、[メインのドキュメントページ](../index.md)を参照してください。

## このセクションのナビゲート

- **[コアツールAPI](./tools-api.md):** コアによるツールの定義、登録、使用方法に関する情報。

## コアの役割

Gemini CLIの`packages/cli`部分がユーザーインターフェイスを提供するのに対し、`packages/core`は次の役割を担います。

- **Gemini APIとの対話:** Google Gemini APIと安全に通信し、ユーザープロンプトを送信し、モデルの応答を受信します。
- **プロンプトエンジニアリング:** Geminiモデルの効果的なプロンプトを構築します。これには、会話履歴、ツールの定義、`GEMINI.md`ファイルからの指示コンテキストを組み込む可能性があります。
- **ツールの管理とオーケストレーション:**
  - 利用可能なツール（ファイルシステムツール、シェルコマンド実行など）を登録します。
  - Geminiモデルからのツール使用リクエストを解釈します。
  - 提供された引数で要求されたツールを実行します。
  - さらなる処理のために、ツール実行結果をGeminiモデルに返します。
- **セッションと状態管理:** 履歴や一貫した対話に必要な関連コンテキストを含む、会話の状態を追跡します。
- **構成:** APIキーアクセス、モデル選択、ツール設定など、コア固有の構成を管理します。

## セキュリティに関する考慮事項

コアはセキュリティにおいて重要な役割を果たします。

- **APIキー管理:** `GEMINI_API_KEY`を処理し、Gemini APIとの通信時に安全に使用されることを保証します。
- **ツール実行:** ツールがローカルシステムと対話する場合（例：`run_shell_command`）、コア（およびその基盤となるツール実装）は、意図しない変更を防ぐために、サンドボックスメカニズムを含む適切な注意を払って実行する必要があります。

## チャット履歴の圧縮

長い会話がGeminiモデルのトークン制限を超えないようにするため、コアにはチャット履歴圧縮機能が含まれています。

会話が構成済みモデルのトークン制限に近づくと、コアはモデルに送信する前に会話履歴を自動的に圧縮します。この圧縮は、伝達される情報に関して損失がないように設計されていますが、使用されるトークンの総数を削減します。

各モデルのトークン制限については、[Google AIドキュメント](https://ai.google.dev/gemini-api/docs/models)で確認できます。

## モデルのフォールバック

Gemini CLIには、デフォルトの「pro」モデルがレート制限されていてもCLIを引き続き使用できるようにするためのモデルフォールバックメカニズムが含まれています。

デフォルトの「pro」モデルを使用していて、CLIがレート制限されていることを検出した場合、現在のセッションでは自動的に「flash」モデルに切り替わります。これにより、中断することなく作業を続けることができます。

## ファイル検出サービス

ファイル検出サービスは、現在のコンテキストに関連するプロジェクト内のファイルを検索する責任があります。これは、`@`コマンドやファイルにアクセスする必要があるその他のツールによって使用されます。

## メモリ検出サービス

メモリ検出サービスは、モデルにコンテキストを提供する`GEMINI.md`ファイルを検索して読み込む責任があります。現在の作業ディレクトリから開始し、プロジェクトのルート、ユーザーのホームディレクトリへと階層的にこれらのファイルを検索します。また、サブディレクトリも検索します。

これにより、グローバル、プロジェクトレベル、コンポーネントレベルのコンテキストファイルを持つことができ、これらすべてが組み合わされて、モデルに最も関連性の高い情報が提供されます。

[`/memory`コマンド](../cli/commands.md)を使用して、読み込まれた`GEMINI.md`ファイルの内容を`show`、`add`、`refresh`できます。 