# Gemini CLIでのサンドボックス化

このドキュメントでは、前提条件、クイックスタート、設定など、Gemini CLIでのサンドボックス化に関するガイドを提供します。

## 前提条件

サンドボックスを使用する前に、Gemini CLIをインストールして設定する必要があります。

```bash
# npmでgemini-cliをインストール
npm install -g @google/gemini-cli

# インストールの確認
gemini --version
```

## サンドボックス化の概要

サンドボックス化は、潜在的に危険な操作（シェルコマンドやファイル変更など）をホストシステムから分離し、AI操作と環境の間にセキュリティバリアを提供します。

サンドボックス化の利点は次のとおりです。

- **セキュリティ**: 偶発的なシステムの損傷やデータ損失を防ぎます。
- **分離**: ファイルシステムへのアクセスをプロジェクトディレクトリに制限します。
- **一貫性**: 異なるシステム間で再現可能な環境を確保します。
- **安全性**: 信頼できないコードや実験的なコマンドを扱う際のリスクを軽減します。

## サンドボックス化の方法

理想的なサンドボックス化の方法は、プラットフォームや好みのコンテナソリューションによって異なる場合があります。

### 1. macOS Seatbelt（macOSのみ）

`sandbox-exec`を使用した軽量で組み込みのサンドボックス化。

**デフォルトプロファイル**: `permissive-open` - プロジェクトディレクトリ外への書き込みを制限しますが、他のほとんどの操作は許可します。

### 2. コンテナベース（Docker/Podman）

完全なプロセス分離を備えたクロスプラットフォームのサンドボックス化。

**注**: サンドボックスイメージをローカルでビルドするか、組織のレジストリから公開されたイメージを使用する必要があります。

## クイックスタート

```bash
# コマンドフラグでサンドボックス化を有効化
gemini -s -p "コード構造を分析"

# 環境変数の使用
export GEMINI_SANDBOX=true
gemini -p "テストスイートを実行"

# settings.jsonでの設定
{
  "sandbox": "docker"
}
```

## 設定

### サンドボックス化の有効化（優先順）

1. **コマンドフラグ**: `-s`または`--sandbox`
2. **環境変数**: `GEMINI_SANDBOX=true|docker|podman|sandbox-exec`
3. **設定ファイル**: `settings.json`の`"sandbox": true`

### macOS Seatbeltプロファイル

組み込みプロファイル（`SEATBELT_PROFILE`環境変数で設定）：

- `permissive-open`（デフォルト）: 書き込み制限、ネットワーク許可
- `permissive-closed`: 書き込み制限、ネットワークなし
- `permissive-proxied`: 書き込み制限、プロキシ経由のネットワーク
- `restrictive-open`: 厳密な制限、ネットワーク許可
- `restrictive-closed`: 最大限の制限

## LinuxのUID/GID処理

サンドボックスは、Linux上のユーザー権限を自動的に処理します。これらの権限を上書きするには、次のようにします。

```bash
export SANDBOX_SET_UID_GID=true   # ホストのUID/GIDを強制
export SANDBOX_SET_UID_GID=false  # UID/GIDマッピングを無効化
```

## トラブルシューティング

### 一般的な問題

**「操作は許可されていません」**

- 操作にはサンドボックス外へのアクセスが必要です。
- より寛容なプロファイルを試すか、マウントポイントを追加してください。

**コマンドが見つからない**

- カスタムDockerfileに追加します。
- `sandbox.bashrc`経由でインストールします。

**ネットワークの問題**

- サンドボックスプロファイルがネットワークを許可しているか確認してください。
- プロキシ設定を確認してください。

### デバッグモード

```bash
DEBUG=1 gemini -s -p "デバッグコマンド"
```

### サンドボックスの検査

```bash
# 環境の確認
gemini -s -p "シェルコマンドを実行: env | grep SANDBOX"

# マウントのリスト
gemini -s -p "シェルコマンドを実行: mount | grep workspace"
```

## セキュリティに関する注意事項

- サンドボックス化はすべてのリスクを軽減しますが、完全になくすわけではありません。
- 作業を許可する最も制限の厳しいプロファイルを使用してください。
- コンテナのオーバーヘッドは、最初のビルド後は最小限です。
- GUIアプリケーションはサンドボックスで動作しない場合があります。

## 関連ドキュメント

- [設定](./cli/configuration.md): すべての設定オプション。
- [コマンド](./cli/commands.md): 利用可能なコマンド。
- [トラブルシューティング](./troubleshooting.md): 一般的なトラブルシューティング。 